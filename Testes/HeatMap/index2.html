<!DOCTYPE html>
<meta charset="utf-8">
<style>
    #calendar {
      margin: 20px;
    }
    .month {
      margin-right: 8px;
    }
    .month-name {
      font-size: 85%;
      fill: #777;
      font-family: Arial, Helvetica;
    }
    .day.hover {
      stroke: #6d6E70;
      stroke-width: 2;
    }
    .day.focus {
      stroke: #ffff33;
      stroke-width: 2;
    }
</style>
<body>

<div id="calendar"></div>

<script src="//d3js.org/d3.v4.min.js"></script>
<script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>
<script>

function drawCalendar(dateData){

  //console.log(dateData)
  /*define as semanas de cada mês**/
  var weeksInMonth = function(month){
      var m = d3.timeMonth.floor(month)//m recebe o mês em especifio 
      return d3.timeWeeks(d3.timeWeek.floor(m), d3.timeMonth.offset(m,1)).length;//retorna a semana de um determinado mês e retorna o mês
  }

  /*Menor data**/
  var minDate = d3.min(dateData, function(d) { 
    return new Date(d.day) 
  })
  /*Maior data**/
  var maxDate = d3.max(dateData, function(d) { 
    return new Date(d.day)
  })

  var cellMargin = 2, //margem da celula
      cellSize = 20; //tamanho da celula

  var day = d3.timeFormat("%w"), //define o formato de dia
      week = d3.timeFormat("%U"), // define o formato de semana
      format = d3.timeFormat("%Y-%m-%d"), // formato de data
      titleFormat = d3.utcFormat("%a, %d-%b"); //
      monthName = d3.timeFormat("%B"), //
      months= d3.timeMonth.range(d3.timeMonth.floor(minDate), maxDate); //apresenta as semanas de (segunda a sexta)formato dia-semana mês dia ano horario (fuso-horario)
      console.log(months)
  /*Cria Canvas SVG **/
  var svg = d3.select("#calendar").selectAll("svg")
    .data(months) //apresenta as semanas de (segunda a sexta)formato dia-semana mês dia ano horario (fuso-horario)
    .enter().append("svg")// cria ggrupo cvg
    .attr("class", "month") //cria class mês
    .attr("height", ((cellSize * 7) + (cellMargin * 8) + 20) ) //define como altura o tamanho da celula vezes 7 + tamanho da margem * 8, os 20 são para os rótulos do mês
    .attr("width", function(d) {//define largura do canvas
      var columns = weeksInMonth(d);
      return ((cellSize * columns) + (cellMargin * (columns + 1)));
    })
    .append("g")

  /*Define onde será escrito o nome de cada mês**/
  svg.append("text")//define texto
    .attr("class", "month-name") //atribui a classe month name
    .attr("y", (cellSize * 7) + (cellMargin * 8) + 15 )//define onde será escrito na posição y
    .attr("x", function(d) {//define onde será escrito na posição x
      var columns = weeksInMonth(d);
        return (((cellSize * columns) + (cellMargin * (columns + 1))) / 2);
    })
    .attr("text-anchor", "middle")
    .text(function(d) { //define o texto a ser escrito
        return monthName(d) //escreve o nome do mÊs
      })

  /*Cria os retângulos **/
  var rect = svg.selectAll("rect.day")//selecionam todos do grupo rect.day
    .data(function(d, i) {//retorna retângulos
        //console.log(d3.timeDays(d, new Date(d.getFullYear(), d.getMonth()+1, 1)) )
         return d3.timeDays(d, new Date(d.getFullYear(), d.getMonth()+1, 1)); //retorna o retângulo referente a cada dia de cada mês
    })
    .enter().append("rect")// adiciona o retangulo
    .attr("class", "day")//adiciona day a uma classe
    .attr("width", cellSize)//define largura
    .attr("height", cellSize)//define altura
    .attr("rx", 3).attr("ry", 3) // rounded corners
    .attr("fill", '#eaeaea') // default light grey fill
    .attr("y", function(d) { //posiciona retângulo no eixo y
        //console.log((day(d) * cellSize) + (day(d) * cellMargin) + cellMargin)
        return (day(d) * cellSize) + (day(d) * cellMargin) + cellMargin; // posiciona nas posições 112 134 2 24 46 68 90
    })
    .attr("x", function(d) { //podição do retângulo no eixo y
        //console.log(((week(d) - week(new Date(d.getFullYear(),d.getMonth(),1))) * cellSize) + ((week(d) - week(new Date(d.getFullYear(),d.getMonth(),1))) * cellMargin) + cellMargin)
        return ((week(d) - week(new Date(d.getFullYear(),d.getMonth(),1))) * cellSize) + ((week(d) - week(new Date(d.getFullYear(),d.getMonth(),1))) * cellMargin) + cellMargin; 
      })//posicionna na pocisão 2 24 46 68 90 112
    .on("mouseover", mouseover)//quando passar o mouse em cima do retÂngulo
    .on("mouseout", mouseout)//quando tirar o mouse de cima do retângulo
    .datum(format); //define os dados em formatos

  rect.append("title")
    .text(function(d) { 
        return titleFormat(new Date(d)); 
    });

  var lookup = d3.nest()
    .key(function(d) { 
        return d.day; 
    })
    .rollup(function(leaves) {
        return d3.sum(leaves, function(d){ return parseInt(d.count); 
        });
    })
    .object(dateData);

  var scale = d3.scaleLinear()
    .domain(d3.extent(dateData, function(d) { 
        return parseInt(d.count); 
    }))
    .range([0.4,1]); // the interpolate used for color expects a number in the range [0,1] but i don't want the lightest part of the color scheme

  rect.filter(function(d) { return d in lookup; })
    .style("fill", function(d) { 
        return d3.interpolatePuBu(scale(lookup[d])); 
    })
    .select("title")
    .text(function(d) { return titleFormat(new Date(d)) + ":  " + lookup[d]; });

    function mouseover(d){
        d3.select(this)
            .classed('hover', true)
            console.log("teste", d)
            var newDonout = original.filter(entry => entry.day === d);
            console.log(newDonout)
            update(newDonout);
           // pieChart(newDonout);
    }

    function mouseout(d){
        d3.select(this)
            .classed('hover', false)
    }
    function update(d){

    }
}

function pieChart(data){
    console.log(data)

    /*Agrupa  os dados de acordo com topicos **/
    var regionsTopic = d3.nest()
    .key(function(d) {  
        return d.topic; 
    })
    .entries(data)
    .reverse();

    //importante olhar esse console para entender a função a cima
    console.log(regionsTopic)

    var myDuration = 600;
    var firstTime = true;

    var width = 960,
        height = 500,
        radius = Math.min(width, height) / 2;

    var color = d3.scaleOrdinal()//arrumar cores
       // .domain(d=>{d.topic})
       // .range(["#98abc5", "#8a89a6", "#7b6888"]);
       .range(d3.schemeCategory20);

    var arc = d3.arc()
        .outerRadius(radius - 100)
        .innerRadius(radius - 20);//cria buraco dentro do circulo

    var labelArc = d3.arc()
        .outerRadius(radius - 40)
        .innerRadius(radius - 40);

    var pie = d3.pie()
        .sort(null)
        .value(function(d) { 
            //console.log(d.key)
           // return d.key; 
           var numberArray = d.values.map(data => data.count)
           var total = numberArray.reduce(function(total, numero) {
                 return Number(total) + Number(numero)
            }, 0)
            console.log(total)
            console.log(d.values.map(data => data.count))
            console.log(d.values.map(data => data.count))
            //return d.values.map(data => data.count)
            return total
           // return d.count; 
        });

    var svg = d3.select("body").append("svg")
        .attr("width", width)
        .attr("height", height)
    .append("g")
        .attr("transform", "translate(" + width / 2 + "," + height / 2 + ")");

    var g = svg.selectAll(".arc")
        .data(pie(regionsTopic))
        //.data(pie(data))
        .enter().append("g")
        .attr("class", "arc")
        console.log(g)

    g.append("path")
        .attr("d", arc)
        .style("fill", function(d) { 
            console.log(d)
            return color(d.value);
         });

    g.append("text")
        .attr("transform", function(d) { return "translate(" + labelArc.centroid(d) + ")"; })
        .attr("dy", ".35em")
        .text(function(d) { 
            //console.log(d.data.key)
            return d.data.key;
            //return d.data.topic; 
        });
       
}
var original = null;
d3.csv("dates.csv", function(response){
  //atribuir para uma const a response 
  original = response;
  drawCalendar(response);
  pieChart(response);
})


</script>